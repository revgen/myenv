#!/bin/sh
#------------------------------------------------------
## {SCRIPT_NAME} - send email with msmtp tool.
##
## Usage: echo "body message" | {SCRIPT_NAME} [subject]
##
## System environment variables:
##   SUBJECT    - subject for the email
##   SMTP_FROM  - sender email address
##   SMTP_TO    - recepient email address
##
## Setup:
## * Install 'msmtp' into the system
## * Copy updated file 'msmtprc' into the /etc/msmtprc
## * Copy the script {SCRIPT_NAME} into your PATH, example /usr/local/bin/
##
## You can specify environment variables in the configuration file:
##   /etc/sendmailslim.conf
##   ~/.config/sendmailslim.conf
#
#  Evgen Rusakov (https://github.com/revgen) 2017 MIT License
#------------------------------------------------------
SCRIPT_NAME=$(basename "${0}")
if [ -f /etc/${SCRIPT_NAME}.conf ]; then
    logger -s "Load config /etc/${SCRIPT_NAME}.conf"
    . /etc/${SCRIPT_NAME}.conf
fi
if [ -f ~/.config/${SCRIPT_NAME}.conf ]; then
    logger -s "Load config ~/.config/${SCRIPT_NAME}.conf"
    . ~/.config/${SCRIPT_NAME}.conf
fi

case "${1}" in
    msmtprc-aws-ses)
        echo "# Example /etc/msmtprc configuration file for AWS SES
defaults
auth            on
tls             on
tls_starttls    on
#tls_certcheck  off
tls_trust_file  /etc/ssl/certs/ca-certificates.crt
logfile
syslog      LOG_MAIL
# AWS SES
account     default
host        email-smtp.us-east-1.amazonaws.com
port        587
from        john.doe@example.com
user        AXXXXXXXXXXXXXXXXXXJ
password    BXDEQndwkueueWaTfgPGYu12jduesjuwmsWF2
"   
        exit 0;;
    help|--help|-h) sed -n '/^##/,/^$/s/^## \{0,1\}//p' "$0" | sed 's/{SCRIPT_NAME}/'"${SCRIPT_NAME}"'/g'; exit 1;;
esac
HOSTNAME=${HOSTNAME:-"$(hostname 2>/dev/null)"}
SMTP_FROM=${SMTP_FROM:-"john.doe@example.com"}
SMTP_TO=${SMTP_TO:-"jane.doe@example.com"}
SUBJECT=${1:-"[${HOSTNAME}] Notification"}
BODY=$(cat)

logger -s "Sending email '${SUBJECT}' to '${SMTP_TO}'..."
echo "From: ${SMTP_FROM}
To: ${SMTP_TO}
Subject: ${SUBJECT}

${BODY}
" | msmtp "${SMTP_TO}" && logger -s "Success sent email to ${SMTP_TO}."

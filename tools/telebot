#!/usr/bin/env bash
# shellcheck shell=sh disable=SC3014 source=/dev/null
# ############################################################################
## Utility script to use a Telegram Bot
##
## Usage: {SCRIPT_NAME} <command> [--alert] [--warning] [message]
## Commands:
##   send <message>     - send message using bot
# ############################################################################
debug() { [ "${DEBUG:-""}" == "true" ] && >&2 echo "$*"; }

api_token=${TELEGRAM_TOKEN:-""}
chat_id=${TELEGRAM_CHAT_ID:-""}

send_message() {
    flag=✉️
    for arg in "$*"; do
        case "${arg:-""}" in
            --alert) flag=❗;;
            --warning) flag=⚠️;;
            *) message="${arg}"
        esac
    done
    message=${message:-""}
    if [ -z "${message}" ]; then
        debug "Read message form the stdin:"
        message=$(cat /dev/stdin)
    fi
    message="${flag} ${message}"

    url="https://api.telegram.org/bot${api_token}/sendMessage"
    debug "Sending message"
    debug "message=${message}" 
    url="${url}?chat_id=${chat_id}&text=${message}"
    # debug "url=${url}"
    output="$(mktemp).log"
    if command -v  curl >/dev/null; then curl -sL "${url}" > "${output}";
    else  wget -qO - "${url}" > "${output}"; fi
    # TODO: add error check
    debug "Sending message success"
    echo ""
    rm -f "${output}"
}

case "${1:-"--help"}" in
    help|--help|-h) show_help;;
    send) shift; send_message "$*";;
    *) echo "Error: command '${1}' not found"; exit 1;;
esac